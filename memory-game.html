<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Memory F1 - Phaser Anim√© avec sons win et fail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body { margin: 0; background: #243; color: #fff; font-family: sans-serif; }
    #game-parent {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh; overflow: hidden; max-width: 1100px; margin: 0 auto;
    }
    #restartBtn {
      position: absolute;
      top: 10px; right: 12px; z-index: 10;
      padding: 6px 16px; border-radius: 5px;
      border: none; background: #0a74da; color: #fff; font-size: 18px; font-weight: bold;
      cursor: pointer; user-select: none; box-shadow: 0 2px 6px #111a;
    }
  </style>
</head>
<body>
  <button id="restartBtn">Rejouer</button>
  <div id="game-parent"></div>
<script>
const PAIRS = 20, COLS = 8, ROWS = 5, CARD_RATIO = 3/2, CARD_GAP_RATIO = 0.03;
let game, matchSound, failSound, winSound;

function getSizes() {
  const parent = document.getElementById('game-parent');
  const w = parent.clientWidth, h = parent.clientHeight;
  let totalGapW = (COLS - 1) * CARD_GAP_RATIO * w, totalGapH = (ROWS - 1) * CARD_GAP_RATIO * h;
  let cardW = (w - totalGapW) / COLS, cardH = cardW / CARD_RATIO, totalCardHeight = ROWS * cardH + totalGapH;
  if (totalCardHeight > h) { cardH = (h - totalGapH) / ROWS; cardW = cardH * CARD_RATIO; }
  let gapW = CARD_GAP_RATIO * cardW, gapH = CARD_GAP_RATIO * cardH;
  let boardW = COLS * cardW + (COLS - 1) * gapW, boardH = ROWS * cardH + (ROWS - 1) * gapH;
  let startX = (w - boardW) / 2 + cardW / 2, startY = (h - boardH) / 2 + cardH / 2;
  return { w, h, cardW, cardH, gapW, gapH, startX, startY };
}

function createConfig() {
  const parent = document.getElementById('game-parent');
  return {
    type: Phaser.AUTO,
    parent: 'game-parent',
    width: parent.clientWidth,
    height: parent.clientHeight,
    backgroundColor: '#243',
    scene: { preload, create },
    scale: { mode: Phaser.Scale.NONE, autoCenter: Phaser.Scale.CENTER_BOTH }
  };
}

function preload() {
  this.load.image('back', 'assets/carte-dos.jpg');
  for (let i = 1; i <= PAIRS; i++) this.load.image('face' + i, 'assets/' + i + '.jpg');
  this.load.audio('matchSound', 'sounds/match.mp3');
  this.load.audio('failSound', 'sounds/fail.mp3');  // Remplace error.mp3 par fail.mp3
  this.load.audio('winSound', 'sounds/win.mp3');
}

function create() {
  let scene = this, cards = [], lockBoard = false, matchedPairs = 0, moves = 0, timer = 0, timerEvent;
  const {cardW, cardH, gapW, gapH, startX, startY, w, h} = getSizes();

  let txtScore = this.add.text(16, 8, 'Coups: 0', { font: '20px Arial', fill: '#ffe', shadow: {offsetX: 1, offsetY: 1, color: "#111", blur: 4, fill: true}});
  let txtTime = this.add.text(w - 150, 8, 'Temps: 0s', { font: '20px Arial', fill: '#ffe', shadow: {offsetX: 1, offsetY: 1, color: "#111", blur: 4, fill: true}});
  let victoryBanner = this.add.text(w/2, h/2, '', { font: '40px Arial', fill: '#0f0', backgroundColor:'#222d', padding: { left: 16, right: 16, top:8, bottom:10 } })
      .setOrigin(0.5,0.5).setAlpha(0);

  matchSound = this.sound.add('matchSound'); 
  failSound = this.sound.add('failSound');
  winSound = this.sound.add('winSound');

  let opened = [], canClick = true;

  // Tableau des valeurs (2 x chaque valeur)
  let values = [];
  for (let i = 1; i <= PAIRS; i++) values.push(i, i);
  Phaser.Utils.Array.Shuffle(values);

  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      let idx = y * COLS + x;
      if(idx >= values.length) break;
      let val = values[idx];
      let px = startX + x * (cardW + gapW);
      let py = startY + y * (cardH + gapH);
      let container = this.add.container(px, py);
      let cardBack = scene.add.image(0, 0, 'back').setDisplaySize(cardW, cardH);
      let cardFace = scene.add.image(0, 0, 'face' + val).setDisplaySize(cardW, cardH).setVisible(false);
      container.add([cardBack, cardFace]);
      container.setSize(cardW, cardH);
      container.setInteractive(new Phaser.Geom.Rectangle(-cardW/2, -cardH/2, cardW, cardH), Phaser.Geom.Rectangle.Contains);
      container.cardValue = val;
      container.flipped = false;
      container.locked = false;
      container.cardBack = cardBack;
      container.cardFace = cardFace;

      container.on('pointerdown', function () {
        if (!canClick || container.flipped || container.locked) return;
        canClick = false;
        scene.tweens.add({
          targets: container,
          scaleX: 0,
          duration: 120,
          onComplete: function () {
            container.cardBack.setVisible(false);
            container.cardFace.setVisible(true);
            scene.tweens.add({
              targets: container,
              scaleX: 1,
              duration: 110,
              onComplete: function () {
                container.flipped = true;
                opened.push(container);

                if (opened.length === 2) {
                  moves++;
                  txtScore.setText("Coups: " + moves);
                  let [c1, c2] = opened;
                  if (c1.cardValue === c2.cardValue) {
                    matchSound.play();
                    c1.locked = c2.locked = true;
                    matchedPairs++;
                    scene.tweens.add({ targets: [c1, c2], scale: 1.12, yoyo: true, duration: 250 });
                    if (matchedPairs === PAIRS) {
                      clearInterval(timerEvent);
                      winSound.play();
                      victoryBanner.setText(`Gagn√© ! üéâ\n${moves} coups, ${timer}s`);
                      victoryBanner.setAlpha(1);
                      scene.tweens.add({targets: victoryBanner, scale:1.12, yoyo:true, duration:320, repeat:2});
                    }
                    opened = []; 
                    setTimeout(()=>canClick=true, 180);
                  } else {
                    failSound.play();
                    setTimeout(() => {
                      scene.tweens.add({
                        targets: [c1, c2],
                        scaleX: 0,
                        duration: 120,
                        onComplete: function () {
                          [c1, c2].forEach(c => {
                            c.cardBack.setVisible(true);
                            c.cardFace.setVisible(false);
                            c.flipped = false;
                          });
                          scene.tweens.add({
                            targets: [c1, c2], scaleX: 1, duration: 100,
                            onComplete: () => { opened = []; canClick = true; }
                          });
                        }
                      });
                    }, 500);
                  }
                } else {
                  canClick = true;
                }
              }
            });
          }
        });
      });
      cards.push(container);
    }
  }

  // Timer d'affichage
  timerEvent = setInterval(() => {
    timer++;
    txtTime.setText("Temps: " + timer + "s");
  }, 1000);

  // Bouton rejouer
  document.getElementById('restartBtn').onclick = () => {
    clearInterval(timerEvent);
    game.destroy(true);
    document.getElementById('game-parent').innerHTML = '';
    setTimeout(() => { game = new Phaser.Game(createConfig()); }, 20);
  };
}

// Redimensionnement: on recr√©e le jeu
window.addEventListener('resize', () => {
  if (game) {
    game.destroy(true);
    document.getElementById('game-parent').innerHTML = '';
    setTimeout(() => { game = new Phaser.Game(createConfig()); }, 20);
  }
});

// Initialisation au chargement de la page
window.onload = () => {
  game = new Phaser.Game(createConfig());
};
</script>
</body>
</html>
