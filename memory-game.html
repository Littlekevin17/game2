<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Memory F1 - Phaser Scene Classe Corrig√©e</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    /* Garde ton CSS pr√©c√©demment utilis√© */
    /* ... */
  </style>
</head>
<body>

<div id="accueil">
  <div id="titre-memory">Memory F1</div>
  <div id="choix-niveau">
    <button class="btn-niveau" data-paires="5">Facile (5 paires)</button>
    <button class="btn-niveau" data-paires="10">Moyen (10 paires)</button>
    <button class="btn-niveau" data-paires="15">Difficile (15 paires)</button>
    <button class="btn-niveau" data-paires="20">Tr√®s difficile (20 paires)</button>
  </div>
  <p style="font-size:1.04em; color:#fff9; margin-top:14px;">
    Trouvez toutes les paires de cartes Formule 1 !<br />
    (adapt√© mobile & desktop)
  </p>
</div>

<div id="header" style="display:none;">
  <div id="infoCoups">Coups: 0</div>
  <button id="restartBtn">Rejouer</button>
  <div id="infoTemps">Temps: 0s</div>
</div>

<div id="game-parent"></div>

<script>
  const CARD_RATIO = 3 / 2; // largeur/hauteur carte
  const CARD_GAP_RATIO = 0.03;

  // Classe Scene Phaser
  class MemoryScene extends Phaser.Scene {
    constructor() {
      super({ key: 'memory' });
      this.nbPairs = 0;
      this.cols = 0;
      this.rows = 0;
      this.moves = 0;
      this.matchedPairs = 0;
      this.timer = 0;
      this.timerEvent = null;
      this.canClick = true;
      this.opened = [];
    }

    init(data) {
      this.nbPairs = data.nbPairs;
      this.cols = data.cols;
      this.rows = data.rows;
      console.log('[MemoryScene] init', data);
    }

    preload() {
      console.log('[MemoryScene] preload', this.nbPairs);
      this.load.image('back', 'assets/carte-dos.jpg');
      for (let i = 1; i <= this.nbPairs; i++) {
        this.load.image('face' + i, 'assets/' + i + '.jpg');
      }
      this.load.audio('matchSound', 'sounds/match.mp3');
      this.load.audio('failSound', 'sounds/fail.mp3');
      this.load.audio('winSound', 'sounds/win.mp3');
    }

    create() {
      const { cardW, cardH, gapW, gapH, startX, startY, w, h } = this.getSizes();
      console.log('[MemoryScene] create', this.cols, this.rows, this.nbPairs, w, h, cardW, cardH);

      document.getElementById('header').style.display = 'flex';

      this.moves = 0;
      this.matchedPairs = 0;
      this.timer = 0;
      this.canClick = true;
      this.opened = [];

      this.infoCoups = document.getElementById('infoCoups');
      this.infoTemps = document.getElementById('infoTemps');
      this.infoCoups.textContent = 'Coups: 0';
      this.infoTemps.textContent = 'Temps: 0s';

      this.matchSound = this.sound.add('matchSound');
      this.failSound = this.sound.add('failSound');
      this.winSound = this.sound.add('winSound');

      this.overlay = this.add.rectangle(w / 2, h / 2, w, h, 0x000000, 0.5).setDepth(20).setVisible(false);
      this.victoryBanner = this.add.text(w / 2, h / 2, '', {
        font: '40px Arial',
        fill: '#0f0',
        backgroundColor: '#222d',
        padding: { left: 24, right: 24, top: 16, bottom: 16 },
        align: 'center',
        wordWrap: { width: w * 0.8 },
      }).setOrigin(0.5).setDepth(21).setVisible(false);

      this.input.once('pointerdown', () => {
        if (this.sound.context.state === 'suspended') this.sound.context.resume();
      });

      if(this.timerEvent){
        clearInterval(this.timerEvent);
      }
      this.timerEvent = setInterval(() => {
        this.timer++;
        this.infoTemps.textContent = 'Temps: ' + this.timer + 's';
      }, 1000);

      let values = [];
      for (let i = 1; i <= this.nbPairs; i++) values.push(i, i);
      Phaser.Utils.Array.Shuffle(values);

      for (let y = 0; y < this.rows; y++) {
        for (let x = 0; x < this.cols; x++) {
          const idx = y * this.cols + x;
          if (idx >= values.length) break;
          const val = values[idx];
          const px = startX + x * (cardW + gapW);
          const py = startY + y * (cardH + gapH);

          console.log(`[MemoryScene] creation carte idx=${idx} val=${val} pos=(${px},${py}) taille=(${cardW},${cardH})`);

          let container = this.add.container(px, py);
          let cardBack = this.add.image(0, 0, 'back').setDisplaySize(cardW, cardH);
          let cardFace = this.add.image(0, 0, 'face' + val).setDisplaySize(cardW, cardH).setVisible(false);

          container.add([cardBack, cardFace]);
          container.setSize(cardW, cardH);
          container.setInteractive();

          container.cardValue = val;
          container.flipped = false;
          container.locked = false;
          container.cardBack = cardBack;
          container.cardFace = cardFace;

          container.on('pointerdown', () => {
            if (!this.canClick || container.flipped || container.locked) return;
            this.canClick = false;
            this.tweens.add({
              targets: container,
              scaleX: 0,
              duration: 120,
              onComplete: () => {
                container.cardBack.setVisible(false);
                container.cardFace.setVisible(true);
                this.tweens.add({
                  targets: container,
                  scaleX: 1,
                  duration: 110,
                  onComplete: () => {
                    container.flipped = true;
                    this.opened.push(container);
                    if(this.opened.length === 2){
                      this.moves++;
                      this.infoCoups.textContent = 'Coups: ' + this.moves;
                      const [c1, c2] = this.opened;
                      if(c1.cardValue === c2.cardValue){
                        this.matchSound.play();
                        c1.locked = c2.locked = true;
                        this.matchedPairs++;
                        this.tweens.add({ targets: [c1, c2], scale: 1.12, yoyo: true, duration: 240 });
                        if(this.matchedPairs === this.nbPairs){
                          clearInterval(this.timerEvent);
                          this.winSound.play();
                          this.overlay.setVisible(true);
                          this.victoryBanner.setText(`Gagn√© ! üéâ\n${this.moves} coups, ${this.timer} secondes`);
                          this.victoryBanner.setVisible(true);
                          this.tweens.add({ targets: this.victoryBanner, scale: 1.12, yoyo: true, duration: 320, repeat: 2 });
                          this.canClick = false;
                        }
                        this.opened = [];
                        setTimeout(() => { this.canClick = true; }, 160);
                      } else {
                        this.failSound.play();
                        setTimeout(() => {
                          this.tweens.add({
                            targets: [c1, c2],
                            scaleX: 0,
                            duration: 120,
                            onComplete: () => {
                              [c1, c2].forEach(c => {
                                c.cardBack.setVisible(true);
                                c.cardFace.setVisible(false);
                                c.flipped = false;
                              });
                              this.tweens.add({
                                targets: [c1, c2], scaleX: 1, duration: 100,
                                onComplete: () => {
                                  this.opened = [];
                                  this.canClick = true;
                                }
                              });
                            }
                          });
                        }, 460);
                      }
                    } else {
                      this.canClick = true;
                    }
                  }
                });
              }
            });
          });
        }
      }

      const restartBtn = document.getElementById('restartBtn');
      restartBtn.onclick = () => {
        clearInterval(this.timerEvent);
        game.destroy(true);
        document.getElementById('game-parent').innerHTML = '';
        setTimeout(() => {
          startGame(this.nbPairs);
        }, 20);
      };
    }

    getSizes() {
      const parent = document.getElementById('game-parent');
      const w = parent.clientWidth, h = parent.clientHeight;
      let totalGapW = (this.cols - 1) * CARD_GAP_RATIO * w;
      let totalGapH = (this.rows - 1) * CARD_GAP_RATIO * h;
      let cardW = (w - totalGapW) / this.cols;
      let cardH = cardW / CARD_RATIO;
      const totalCardHeight = this.rows * cardH + totalGapH;
      if (totalCardHeight > h) {
        cardH = (h - totalGapH) / this.rows;
        cardW = cardH * CARD_RATIO;
      }
      const gapW = CARD_GAP_RATIO * cardW;
      const gapH = CARD_GAP_RATIO * cardH;
      const boardWidth = this.cols * cardW + (this.cols - 1) * gapW;
      const boardHeight = this.rows * cardH + (this.rows - 1) * gapH;
      const startX = (w - boardWidth) / 2 + cardW / 2;
      const startY = (h - boardHeight) / 2 + cardH / 2;
      return { w, h, cardW, cardH, gapW, gapH, startX, startY };
    }
  }

  function startGame(nbPairs) {
    const { cols, rows } = getPlateau(nbPairs);
    PAIRS = nbPairs;
    COLS = cols;
    ROWS = rows;
    document.getElementById('accueil').style.display = 'none';
    document.getElementById('header').style.display = 'flex';
    document.getElementById('game-parent').innerHTML = '';

    setTimeout(() => {
      const gameParent = document.getElementById('game-parent');
      console.log(
        'Taille #game-parent au lancement Phaser : width =',
        gameParent.clientWidth,
        'height =',
        gameParent.clientHeight
      );
      game = new Phaser.Game(createConfig(cols, rows, nbPairs));
      setTimeout(() => {
        const canvas = document.querySelector('#game-parent canvas');
        if (canvas) {
          console.log(
            '[MEMORY-F1] Canvas cr√©√©, taille:',
            canvas.width,
            canvas.height,
            'Visibilit√©:',
            canvas.style.display,
            canvas.style.visibility
          );
        } else {
          console.log('[MEMORY-F1] Canvas NON trouv√© dans #game-parent apr√®s instanciation Phaser');
        }
      }, 400);
    }, 150);
  }

  document.querySelectorAll('.btn-niveau').forEach((btn) => {
    btn.addEventListener('click', function () {
      const nb = parseInt(this.dataset.paires, 10);
      startGame(nb);
    });
  });

  window.addEventListener('resize', () => {
    if (game && game.scene && game.scene.scenes[0] && typeof PAIRS !== 'undefined') {
      game.destroy(true);
      document.getElementById('game-parent').innerHTML = '';
      setTimeout(() => {
        startGame(PAIRS || 20);
      }, 100);
    }
  });

  window.onload = () => {
    document.getElementById('accueil').style.display = 'flex';
    document.getElementById('header').style.display = 'none';
  };
</script>
</body>
</html>
