<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Memory F1 - Phaser</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body { margin:0; background:#243; color:#fff; font-family:sans-serif;}
    canvas { display:block; margin:40px auto;}
    button {
      display: block;
      margin: 15px auto;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="restartBtn">Rejouer</button>
  <script>
    const PAIRS = 20;
    const CARD_WIDTH = 80;
    const CARD_HEIGHT = 100;
    const COLS = 8; // Largeur de la grille
    const ROWS = 5; // 8x5 = 40 cases (20 paires)

    let cards, firstCard, secondCard, lockBoard, matchedPairs;
    let scoreText, timerText, restartBtn, timer, clickCount = 0, timerInterval;
    let matchSound;

    function preload() {
      this.load.image('back', 'assets/carte-dos.jpg');
      for (let i = 1; i <= PAIRS; i++) {
        this.load.image('face' + i, 'assets/' + i + '.jpg');
      }
      this.load.audio('matchSound', 'sounds/match.mp3');
    }

    function create() {
      cards = [];
      lockBoard = false;
      matchedPairs = 0;
      clickCount = 0;
      firstCard = null;
      secondCard = null;
      timer = 0;

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timer++;
        timerText.setText('Temps: ' + timer + 's');
      }, 1000);

      // PrÃ©pare 2*PAIRS indices, chaque image deux fois
      let values = [];
      for (let i = 1; i <= PAIRS; i++) {
        values.push(i, i);
      }
      Phaser.Utils.Array.Shuffle(values);

      let idx = 0;
      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          if (idx >= values.length) break;
          let val = values[idx++];
          let card = this.add.image(60 + x * 85, 80 + y * 110, 'back')
            .setInteractive()
            .setData('value', val)
            .setData('flipped', false);
          card.on('pointerdown', () => onCardClick.call(this, card));
          cards.push(card);
        }
      }

      scoreText = this.add.text(10, 15, 'Coups: 0', { font:'20px Arial', fill:'#fff' });
      timerText = this.add.text(500, 15, 'Temps: 0s', { font:'20px Arial', fill:'#fff' });

      matchSound = this.sound.add('matchSound');

      restartBtn = document.getElementById('restartBtn');
      restartBtn.onclick = () => {
        clearInterval(timerInterval);
        this.scene.restart();
      };
    }

    function onCardClick(card) {
      if (lockBoard || card.getData('flipped')) return;
      card.setTexture('face' + card.getData('value'));
      card.setData('flipped', true);

      clickCount++;
      scoreText.setText('Coups: ' + clickCount);

      if (!firstCard) {
        firstCard = card;
      } else {
        secondCard = card;
        lockBoard = true;
        this.time.delayedCall(800, () => {
          if (firstCard.getData('value') === secondCard.getData('value')) {
            matchedPairs += 1;
            matchSound.play();
            if (matchedPairs === PAIRS) {
              clearInterval(timerInterval);
              this.add.text(250, 650, 'GagnÃ© ! ðŸŽ‰', { font:'32px Arial', fill:'#0f0' });
            }
          } else {
            firstCard.setTexture('back');
            secondCard.setTexture('back');
            firstCard.setData('flipped', false);
            secondCard.setData('flipped', false);
          }
          firstCard = secondCard = null;
          lockBoard = false;
        });
      }
    }

    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 720,
      scene: { preload, create }
    };

    const game = new Phaser.Game(config);
  </script>
</body>
</html>
