<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Memory F1 - Jeu complet et stable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #243;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      user-select:none;
      overflow: hidden;
    }
    #accueil {
      position: absolute;
      top: 0; bottom:0; left:0; right:0;
      background: linear-gradient(135deg,#031d3dcc 40%,#15312acc 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align:center;
      padding: 0 12px;
      box-sizing: border-box;
      user-select:none;
    }
    #accueil h1 {
      font-family: 'Bebas Neue', cursive;
      font-size: 4rem;
      color: #f4c20d;
      text-shadow: 2px 2px 8px #111;
      margin: 0 0 1rem 0;
      user-select:none;
    }
    #accueil .buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      max-width: 500px;
      width: 100%;
    }
    #accueil button {
      flex: 1 1 140px;
      min-width: 140px;
      background: linear-gradient(90deg,#00c3ff 0%,#ffc300 120%);
      border: none;
      border-radius: 8px;
      color: #202020;
      font-weight: bold;
      font-size: 1.3rem;
      padding: 14px 4px;
      cursor: pointer;
      box-shadow: 0 2px 8px #0007;
      user-select:none;
      transition: background 0.3s ease;
    }
    #accueil button:hover {
      background: linear-gradient(90deg,#0092bc 0%,#c28800 120%);
    }
    #accueil p {
      margin-top: 1.5rem;
      font-size: 1rem;
      color: #eee;
      user-select:none;
    }
    #header {
      display:none;
      position: fixed;
      top:0; left:0; right:0;
      height: 50px;
      background: #111a;
      color: #eee;
      font-size: 1.1rem;
      line-height: 50px;
      user-select:none;
      text-align: center;
      font-weight: bold;
      z-index: 999;
      display: flex;
      justify-content: space-between;
      padding: 0 12px;
      box-sizing: border-box;
    }
    #header div {
      min-width: 100px;
      text-align: center;
    }
    #header button {
      background: #00a6ff;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      padding: 8px 18px;
      font-size: 1rem;
      user-select:none;
    }
    #header button:hover {
      background: #007fb3;
    }
    #game-container {
      position: fixed;
      top: 50px;
      left: 0; right:0; bottom:0;
      background: #222;
      margin: auto;
      overflow: hidden;
    }
    canvas {
      display: block;
      user-select:none;
    }
  </style>
</head>
<body>

<!-- Accueil -->
<div id="accueil">
  <h1>Memory F1</h1>
  <div class="buttons">
    <button data-pairs="5">Facile (5 paires)</button>
    <button data-pairs="10">Moyen (10 paires)</button>
    <button data-pairs="15">Difficile (15 paires)</button>
    <button data-pairs="20">Très difficile (20 paires)</button>
  </div>
  <p>Trouvez toutes les paires aussi vite que possible !</p>
</div>

<!-- Barre de stats -->
<div id="header">
  <div id="moves">Coups: 0</div>
  <button id="restart">Rejouer</button>
  <div id="timer">Temps: 0s</div>
</div>

<!-- Container pour Phaser -->
<div id="game-container"></div>

<script>
  const CARD_RATIO = 3 / 2;
  const CARD_GAP_RATIO = 0.03;

  let game;
  let currentPairs = 0, cols = 0, rows = 0;

  class MemoryScene extends Phaser.Scene {
    constructor() {
      super({ key: 'memory' });
      this.pairsCount = 0;
      this.cols = 0;
      this.rows = 0;
      this.moves = 0;
      this.timer = 0;
      this.matchedCount = 0;
      this.cardSize = { width: 0, height: 0 };
      this.cardsGroup = [];
      this.opened = [];
      this.canClick = true;
      this.timerEvent = null;
      this.overlay = null;
      this.victoryText = null;
    }

    init(data) {
      this.pairsCount = data.pairsCount;
      this.cols = data.cols;
      this.rows = data.rows;
      console.log('Scene init:', data);
    }

    preload() {
      console.log(`Scene preload: ${this.pairsCount} paires à charger`);
      this.load.image('back', 'assets/carte-dos.jpg');
      for (let i = 1; i <= this.pairsCount; i++) {
        this.load.image(`face${i}`, `assets/${i}.jpg`);
      }
      this.load.audio('match', 'sounds/match.mp3');
      this.load.audio('fail', 'sounds/fail.mp3');
      this.load.audio('win', 'sounds/win.mp3');
    }

    create() {
      const parent = document.getElementById('game-container');
      const w = parent.clientWidth;
      const h = parent.clientHeight;
      console.log(`Scene create sizes: ${w}x${h}`);

      this.cardSize = this.calcCardSize(w, h);

      this.moves = 0;
      this.timer = 0;
      this.matchedCount = 0;
      this.opened = [];
      this.canClick = true;

      this.movesText = document.getElementById('moves');
      this.timerText = document.getElementById('timer');
      this.movesText.textContent = 'Coups: 0';
      this.timerText.textContent = 'Temps: 0s';

      this.matchSound = this.sound.add('match');
      this.failSound = this.sound.add('fail');
      this.winSound = this.sound.add('win');

      this.overlay = this.add.rectangle(w / 2, h / 2, w, h, 0x000000, 0.5).setDepth(10).setVisible(false);
      this.victoryText = this.add.text(w / 2, h / 2, '', {
        fontSize: '48px',
        color: '#0f0',
        backgroundColor: 'rgba(0,0,0,0.7)',
        padding: { x: 20, y: 10 },
        align: 'center',
        wordWrap: { width: w * 0.8 },
      }).setOrigin(0.5).setDepth(11).setVisible(false);

      this.input.once('pointerdown', () => {
        if (this.sound.context.state === 'suspended') this.sound.context.resume();
      });

      if (this.timerEvent) {
        clearInterval(this.timerEvent);
      }
      this.timerEvent = setInterval(() => {
        this.timer++;
        this.timerText.textContent = `Temps: ${this.timer}s`;
      }, 1000);

      const cardsValues = [];
      for(let i = 1; i <= this.pairsCount; i++) {
        cardsValues.push(i);
        cardsValues.push(i);
      }
      Phaser.Utils.Array.Shuffle(cardsValues);

      const {startX, startY} = this.calcStartPosition(w, h, this.cols, this.rows, this.cardSize);

      for(let i = 0; i < cardsValues.length; i++) {
        const col = i % this.cols;
        const row = Math.floor(i / this.cols);
        const x = startX + col * (this.cardSize.width + this.cardSize.width * CARD_GAP_RATIO);
        const y = startY + row * (this.cardSize.height + this.cardSize.height * CARD_GAP_RATIO);

        console.log(`Création carte idx=${i} val=${cardsValues[i]} pos=(${x},${y}) taille=(${this.cardSize.width},${this.cardSize.height})`);

        const container = this.add.container(x, y);
        const cardBack = this.add.image(0, 0, 'back').setDisplaySize(this.cardSize.width, this.cardSize.height);
        const cardFace = this.add.image(0, 0, `face${cardsValues[i]}`).setDisplaySize(this.cardSize.width, this.cardSize.height).setVisible(false);
        container.add([cardBack, cardFace]);
        container.setSize(this.cardSize.width, this.cardSize.height);
        container.setInteractive();

        container.cardValue = cardsValues[i];
        container.isFlipped = false;
        container.isMatched = false;
        container.cardBack = cardBack;
        container.cardFace = cardFace;

        container.on('pointerdown', () => {
          if (!this.canClick || container.isFlipped || container.isMatched) return;

          this.canClick = false;
          this.tweens.add({
            targets: container,
            scaleX: 0,
            duration: 120,
            onComplete: () => {
              container.cardBack.setVisible(false);
              container.cardFace.setVisible(true);
              this.tweens.add({
                targets: container,
                scaleX: 1,
                duration: 110,
                onComplete: () => {
                  container.isFlipped = true;
                  this.opened.push(container);

                  if (this.opened.length === 2) {
                    this.moves++;
                    this.movesText.textContent = `Coups: ${this.moves}`;
                    const [cardA, cardB] = this.opened;
                    if (cardA.cardValue === cardB.cardValue) {
                      this.matchSound.play();
                      cardA.isMatched = true;
                      cardB.isMatched = true;
                      this.matchedCount++;

                      this.tweens.add({
                        targets: [cardA, cardB],
                        scale: 1.15,
                        yoyo: true,
                        ease: 'Power1',
                        duration: 250,
                      });

                      if (this.matchedCount === this.pairsCount) {
                        clearInterval(this.timerEvent);
                        this.winSound.play();
                        this.overlay.setVisible(true);
                        this.victoryText.setText(`Bravo !\nCoups: ${this.moves}\nTemps: ${this.timer}s`);
                        this.victoryText.setVisible(true);
                        this.tweens.add({
                          targets: this.victoryText,
                          scale: 1.2,
                          yoyo: true,
                          repeat: 3,
                          duration: 300,
                        });
                        this.canClick = false;
                      }
                      this.opened = [];
                      this.time.delayedCall(500, () => {
                        this.canClick = true;
                      });
                    } else {
                      this.failSound.play();
                      this.time.delayedCall(700, () => {
                        this.tweens.add({
                          targets: [cardA, cardB],
                          scaleX: 0,
                          duration: 120,
                          onComplete: () => {
                            cardA.cardBack.setVisible(true);
                            cardB.cardBack.setVisible(true);
                            cardA.cardFace.setVisible(false);
                            cardB.cardFace.setVisible(false);
                            cardA.isFlipped = false;
                            cardB.isFlipped = false;
                            this.tweens.add({
                              targets: [cardA, cardB],
                              scaleX: 1,
                              duration: 120,
                              onComplete: () => {
                                this.opened = [];
                                this.canClick = true;
                              }
                            });
                          }
                        });
                      });
                    }
                  } else {
                    this.canClick = true;
                  }
                }
              });
            }
          });
        });
      }

      // Setup bouton rejouer
      const restartBtn = document.getElementById('restart');
      restartBtn.onclick = () => {
        clearInterval(this.timerEvent);
        this.scene.stop();
        this.game.destroy(true);
        document.getElementById('game-container').innerHTML = '';
        this.canClick = false;
        setTimeout(() => startGame(this.pairsCount), 50);
      };
    }

    calcCardSize(w, h) {
      const cardWidth = w / this.cols * (1 - CARD_GAP_RATIO);
      let cardHeight = cardWidth / CARD_RATIO;

      if ((cardHeight * this.rows + (this.rows - 1) * cardHeight * CARD_GAP_RATIO) > h) {
        cardHeight = h / this.rows * (1 - CARD_GAP_RATIO);
        return { width: cardHeight * CARD_RATIO, height: cardHeight };
      }
      return { width: cardWidth, height: cardHeight };
    }

    calcStartPosition(w, h, cols, rows, cardSize) {
      const gapW = cardSize.width * CARD_GAP_RATIO;
      const gapH = cardSize.height * CARD_GAP_RATIO;

      const boardWidth = cols * cardSize.width + (cols - 1) * gapW;
      const boardHeight = rows * cardSize.height + (rows - 1) * gapH;

      return {
        startX: (w - boardWidth) / 2 + cardSize.width / 2,
        startY: (h - boardHeight) / 2 + cardSize.height / 2
      };
    }
  }

  // Lance partie avec une configuration de plateau calculée
  function startGame(nbPairs) {
    const plateau = getPlateau(nbPairs);
    cols = plateau.cols;
    rows = plateau.rows;
    PAIRS = nbPairs;
    document.getElementById('accueil').style.display = 'none';
    document.getElementById('header').style.display = 'flex';
    document.getElementById('game-container').innerHTML = '';

    setTimeout(() => {
      console.log(`Démarrage du jeu - Container taille: ${document.getElementById('game-container').clientWidth} x ${document.getElementById('game-container').clientHeight}`);

      game = new Phaser.Game({
        type: Phaser.AUTO,
        parent: 'game-container',
        width: document.getElementById('game-container').clientWidth,
        height: document.getElementById('game-container').clientHeight,
        backgroundColor: '#243',
        scene: new MemoryScene(),
        scale: { mode: Phaser.Scale.NONE, autoCenter: Phaser.Scale.CENTER_BOTH },
        pack: {
          files: [
            { type: 'image', key: 'back', url: 'assets/carte-dos.jpg' }
          ]
        },
        data: { pairsCount: nbPairs, cols: cols, rows: rows }
      });
    }, 150);
  }

  // Gestion boutons
  document.querySelectorAll('#accueil .btn-niveau').forEach(button => {
    button.addEventListener('click', () => {
      const pairs = parseInt(button.dataset.pairs, 10);
      if (isNaN(pairs)) return;
      startGame(pairs);
    });
  });

  // Rejouer bouton (ré-appelé depuis scène, mais au cas)
  document.getElementById('restart').addEventListener('click', () => {
    if (game) {
      game.destroy(true);
      document.getElementById('game-container').innerHTML = '';
      startGame(PAIRS);
    }
  });

  window.addEventListener('resize', () => {
    if (game) {
      game.destroy(true);
      document.getElementById('game-container').innerHTML = '';
      startGame(PAIRS);
    }
  });

  window.onload = () => {
    document.getElementById('accueil').style.display = 'flex';
    document.getElementById('header').style.display = 'none';
  };
</script>

</body>
</html>
