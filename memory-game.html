<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Memory F1 - Phaser Anim√© corrig√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      background: #243;
      color: #fff;
      font-family: sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      overflow: hidden;
    }
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      background: #111c;
      color: #fff;
      font-size: 16px;
      position: relative;
      height: 40px;
      max-width: 1100px;
      margin: 10px auto 0;
      border-radius: 5px;
    }
    #header > div {
      min-width: 75px;
      text-align: center;
    }
    #restartBtn {
      margin: 0 auto;
      position: static;
      cursor: pointer;
      padding: 6px 16px;
      border-radius: 5px;
      border: none;
      background: #0a74da;
      color: white;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 6px #111a;
      user-select: none;
    }
    #game-parent {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      top: 60px; /* sous le header */
      width: 100vw;
      height: calc(100vh - 60px);
      max-width: 1100px;
      margin: 0 auto;
      background: #222;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      image-rendering: crisp-edges;
      user-select: none;
    }
  </style>
</head>
<body>

<div id="header">
  <div id="infoCoups">Coups: 0</div>
  <button id="restartBtn">Rejouer</button>
  <div id="infoTemps">Temps: 0s</div>
</div>

<div id="game-parent"></div>

<script>
  const PAIRS = 20;
  const COLS = 8;
  const ROWS = 5;
  const CARD_RATIO = 3 / 2; // largeur/hauteur
  const CARD_GAP_RATIO = 0.03;

  let game, matchSound, failSound, winSound;

  function getSizes() {
    const parent = document.getElementById('game-parent');
    const w = parent.clientWidth, h = parent.clientHeight;
    let totalGapW = (COLS - 1) * CARD_GAP_RATIO * w;
    let totalGapH = (ROWS - 1) * CARD_GAP_RATIO * h;
    let cardW = (w - totalGapW) / COLS;
    let cardH = cardW / CARD_RATIO;
    const totalCardHeight = ROWS * cardH + totalGapH;
    if (totalCardHeight > h) {
      cardH = (h - totalGapH) / ROWS;
      cardW = cardH * CARD_RATIO;
    }
    const gapW = CARD_GAP_RATIO * cardW;
    const gapH = CARD_GAP_RATIO * cardH;
    const boardWidth = COLS * cardW + (COLS - 1) * gapW;
    const boardHeight = ROWS * cardH + (ROWS - 1) * gapH;
    const startX = (w - boardWidth) / 2 + cardW / 2;
    const startY = (h - boardHeight) / 2 + cardH / 2;
    return { w, h, cardW, cardH, gapW, gapH, startX, startY };
  }

  function createConfig() {
    const parent = document.getElementById('game-parent');
    return {
      type: Phaser.AUTO,
      parent: 'game-parent',
      width: parent.clientWidth,
      height: parent.clientHeight,
      backgroundColor: '#243',
      scene: { preload, create },
      scale: { mode: Phaser.Scale.NONE, autoCenter: Phaser.Scale.CENTER_BOTH }
    };
  }

  function preload() {
    this.load.image('back', 'assets/carte-dos.jpg');
    for (let i = 1; i <= PAIRS; i++) {
      this.load.image('face' + i, 'assets/' + i + '.jpg');
    }
    this.load.audio('matchSound', 'sounds/match.mp3');
    this.load.audio('failSound', 'sounds/fail.mp3');
    this.load.audio('winSound', 'sounds/win.mp3');
  }

  function create() {
    const scene = this;
    const { cardW, cardH, gapW, gapH, startX, startY, w, h } = getSizes();

    let moves = 0;
    let matchedPairs = 0;
    let timer = 0;
    let opened = [];
    let canClick = true;

    // R√©f√©rences √©l√©ments du header
    const infoCoups = document.getElementById('infoCoups');
    const infoTemps = document.getElementById('infoTemps');
    infoCoups.textContent = 'Coups: 0';
    infoTemps.textContent = 'Temps: 0s';

    matchSound = this.sound.add('matchSound');
    failSound = this.sound.add('failSound');
    winSound = this.sound.add('winSound');

    // Texte victoire au centre du canvas
    let victoryBanner = this.add.text(w / 2, h / 2, '', {
      font: '40px Arial',
      fill: '#0f0',
      backgroundColor: '#222d',
      padding: { left: 16, right: 16, top: 8, bottom: 10 },
      align: 'center',
      wordWrap: { width: w * 0.8 }
    }).setOrigin(0.5).setAlpha(0);

    // Timer incr√©ment√© chaque seconde
    const timerEvent = setInterval(() => {
      timer++;
      infoTemps.textContent = "Temps: " + timer + "s";
    }, 1000);

    // M√©langer les cartes
    let values = [];
    for (let i = 1; i <= PAIRS; i++) values.push(i, i);
    Phaser.Utils.Array.Shuffle(values);

    // Cr√©ation des cartes avec containers (pour animation flip)
    for (let y = 0; y < ROWS; y++) {
      for (let x = 0; x < COLS; x++) {
        let idx = y * COLS + x;
        if (idx >= values.length) break;
        let val = values[idx];
        let px = startX + x * (cardW + gapW);
        let py = startY + y * (cardH + gapH);
        let container = this.add.container(px, py);
        let cardBack = scene.add.image(0, 0, 'back').setDisplaySize(cardW, cardH);
        let cardFace = scene.add.image(0, 0, 'face' + val).setDisplaySize(cardW, cardH).setVisible(false);
        container.add([cardBack, cardFace]);
        container.setSize(cardW, cardH);
        container.setInteractive();
        container.cardValue = val;
        container.flipped = false;
        container.locked = false;
        container.cardBack = cardBack;
        container.cardFace = cardFace;

        container.on('pointerdown', function () {
          if (!canClick || container.flipped || container.locked) return;
          canClick = false;
          scene.tweens.add({
            targets: container,
            scaleX: 0,
            duration: 120,
            onComplete: () => {
              container.cardBack.setVisible(false);
              container.cardFace.setVisible(true);
              scene.tweens.add({
                targets: container,
                scaleX: 1,
                duration: 110,
                onComplete: () => {
                  container.flipped = true;
                  opened.push(container);
                  if (opened.length === 2) {
                    moves++;
                    infoCoups.textContent = "Coups: " + moves;
                    let [c1, c2] = opened;
                    if (c1.cardValue === c2.cardValue) {
                      matchSound.play();
                      c1.locked = c2.locked = true;
                      matchedPairs++;
                      scene.tweens.add({ targets: [c1, c2], scale: 1.12, yoyo: true, duration: 250 });
                      if (matchedPairs === PAIRS) {
                        clearInterval(timerEvent);
                        winSound.play();
                        victoryBanner.setText(`Gagn√© ! üéâ\n${moves} coups, ${timer}s`);
                        victoryBanner.setAlpha(1);
                        scene.tweens.add({ targets: victoryBanner, scale: 1.12, yoyo: true, duration: 320, repeat: 2 });
                      }
                      opened = [];
                      setTimeout(() => { canClick = true; }, 180);
                    } else {
                      failSound.play();
                      setTimeout(() => {
                        scene.tweens.add({
                          targets: [c1, c2],
                          scaleX: 0,
                          duration: 120,
                          onComplete: () => {
                            [c1, c2].forEach(c => {
                              c.cardBack.setVisible(true);
                              c.cardFace.setVisible(false);
                              c.flipped = false;
                            });
                            scene.tweens.add({
                              targets: [c1, c2], scaleX: 1, duration: 100,
                              onComplete: () => { opened = []; canClick = true; }
                            });
                          }
                        });
                      }, 500);
                    }
                  } else {
                    canClick = true;
                  }
                }
              });
            }
          });
        });
      }
    }

    // Bouton Rejouer
    const restartBtn = document.getElementById('restartBtn');
    restartBtn.onclick = () => {
      clearInterval(timerEvent);
      game.destroy(true);
      document.getElementById('game-parent').innerHTML = '';
      setTimeout(() => {
        game = new Phaser.Game(createConfig());
      }, 20);
    };
  }

  // Redimensionnement : recr√©e le jeu Phaser
  window.addEventListener('resize', () => {
    if (game) {
      game.destroy(true);
      document.getElementById('game-parent').innerHTML = '';
      setTimeout(() => {
        game = new Phaser.Game(createConfig());
      }, 20);
    }
  });

  // D√©marrage initial
  window.onload = () => {
    game = new Phaser.Game(createConfig());
  };
</script>

</body>
</html>
