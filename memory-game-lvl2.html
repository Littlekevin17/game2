<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Memory F1 - 10 Paires</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      background: #243;
      color: #fff;
      font-family: sans-serif;
      user-select: none;
      overflow: hidden;
    }
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      background: #111c;
      color: #fff;
      font-size: 16px;
      height: 40px;
      max-width: 1100px;
      margin: 10px auto 0;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #header > div {
      min-width: 75px;
      text-align: center;
      flex-shrink: 0;
    }
    .header-center {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    #restartBtn, #fullscreenBtn {
      margin: 0;
      position: static;
      cursor: pointer;
      padding: 6px 14px;
      border-radius: 5px;
      border: none;
      background: #0a74da;
      color: white;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 6px #111a;
      user-select: none;
      transition: background 0.2s;
    }
    #fullscreenBtn {
      font-size: 20px;
      padding: 6px 10px;
      margin-left: 3px;
      background: #0a5ba8;
      min-width: 36px;
      width: 36px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #restartBtn:hover, #fullscreenBtn:hover {
      background: #09508c;
    }
    #game-container {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      top: 60px; /* sous le header */
      width: 100vw;
      height: calc(100vh - 60px);
      max-width: 1100px;
      margin: 0 auto;
      background: #222;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      image-rendering: crisp-edges;
      user-select: none;
    }
    @media (max-width: 700px) {
      #header {
        font-size: 13px;
        height: 36px;
        padding: 3px 5px;
      }
      #restartBtn, #fullscreenBtn {
        font-size: 15px;
        padding: 4px 7px;
        height: 32px;
      }
      .header-center {
        gap: 4px;
      }
    }
  </style>
</head>
<body>
  <div id="header">
    <div id="infoMoves">Coups: 0</div>
    <div class="header-center">
      <button id="restartBtn">Rejouer</button>
      <button id="fullscreenBtn" title="Plein écran">🔲</button>
    </div>
    <div id="infoTimer">Temps: 0s</div>
  </div>

  <div id="game-container"></div>

  <script>
    const PAIRS = 10;
    const COLS = 5; // 5 colonnes pour 20 cartes
    const ROWS = 4; // 4 lignes correspondantes
    const CARD_RATIO = 3 / 2;
    const CARD_GAP = 0.03;

    let game, matchSound, failSound, winSound;

    function getSizes() {
      const container = document.getElementById('game-container');
      const w = container.clientWidth;
      const h = container.clientHeight;
      const gapWTotal = (COLS - 1) * CARD_GAP * w;
      const gapHTotal = (ROWS - 1) * CARD_GAP * h;
      let cardW = (w - gapWTotal) / COLS;
      let cardH = cardW / CARD_RATIO;
      if (cardH * ROWS + gapHTotal > h) {
        cardH = (h - gapHTotal) / ROWS;
        cardW = cardH * CARD_RATIO;
      }
      const gapW = CARD_GAP * cardW;
      const gapH = CARD_GAP * cardH;
      const boardW = cardW * COLS + gapW * (COLS -1);
      const boardH = cardH * ROWS + gapH * (ROWS -1);
      const startX = (w - boardW) / 2 + cardW/2;
      const startY = (h - boardH) / 2 + cardH/2;

      return { w, h, cardW, cardH, gapW, gapH, startX, startY };
    }

    function createConfig() {
      return {
        type: Phaser.AUTO,
        parent: 'game-container',
        width: document.getElementById('game-container').clientWidth,
        height: document.getElementById('game-container').clientHeight,
        backgroundColor: '#243',
        scene: { preload, create },
        scale: {
          mode: Phaser.Scale.NONE,
          autoCenter: Phaser.Scale.CENTER_BOTH
        }
      };
    }

    function preload() {
      this.load.image('back', 'assets/carte-dos.jpg');
      for(let i=1; i<=PAIRS; i++) {
        this.load.image('face' + i, `assets/${i}.jpg`);
      }
      this.load.audio('matchSound', 'sounds/match.mp3');
      this.load.audio('failSound', 'sounds/fail.mp3');
      this.load.audio('winSound', 'sounds/win.mp3');
    }

    function create() {
      const scene = this;
      const { cardW, cardH, gapW, gapH, startX, startY, w, h } = getSizes();

      let moves = 0;
      let matchedPairs = 0;
      let timer = 0;
      let opened = [];
      let canClick = true;

      const infoMoves = document.getElementById('infoMoves');
      const infoTimer = document.getElementById('infoTimer');
      infoMoves.textContent = 'Coups: 0';
      infoTimer.textContent = 'Temps: 0s';

      matchSound = this.sound.add('matchSound');
      failSound = this.sound.add('failSound');
      winSound = this.sound.add('winSound');

      const overlay = this.add.rectangle(w/2, h/2, w, h, 0x000000, 0.5).setDepth(20).setVisible(false);
      const victoryText = this.add.text(w/2, h/2, '', { 
        font: '40px Arial', 
        fill: '#0f0', 
        backgroundColor: '#222d',
        padding: { left: 24, right: 24, top: 16, bottom: 16 }, 
        align: 'center', 
        wordWrap: { width: w*0.8 } 
      }).setOrigin(0.5).setDepth(21).setVisible(false);

      this.input.once('pointerdown', () => {
        if(this.sound.context.state === 'suspended') this.sound.context.resume();
      });

      const timerEvent = setInterval(() => {
        timer++;
        infoTimer.textContent = `Temps: ${timer}s`;
      }, 1000);

      let values = [];
      for(let i=1; i<=PAIRS; i++) {
        values.push(i);
        values.push(i);
      }
      Phaser.Utils.Array.Shuffle(values);

      for(let y=0; y<ROWS; y++) {
        for(let x=0; x<COLS; x++) {
          let idx = y*COLS + x;
          if(idx >= values.length) break;
          let val = values[idx];
          let px = startX + x*(cardW + gapW);
          let py = startY + y*(cardH + gapH);
          let container = scene.add.container(px, py);

          let cardBack = scene.add.image(0,0,'back').setDisplaySize(cardW, cardH);
          let cardFace = scene.add.image(0,0,'face' + val).setDisplaySize(cardW, cardH).setVisible(false);

          container.add([cardBack, cardFace]);
          container.setSize(cardW, cardH);
          container.setInteractive();

          container.cardBack = cardBack;
          container.cardFace = cardFace;
          container.cardValue = val;
          container.flipped = false;
          container.locked = false;

          container.on('pointerdown', () => {
            if(!canClick || container.flipped || container.locked) return;
            canClick = false;

            scene.tweens.add({
              targets: container,
              scaleX: 0,
              duration: 120,
              onComplete: () => {
                container.cardBack.setVisible(false);
                container.cardFace.setVisible(true);

                scene.tweens.add({
                  targets: container,
                  scaleX: 1,
                  duration: 110,
                  onComplete: () => {
                    container.flipped = true;
                    opened.push(container);

                    if (opened.length === 2) {
                      moves++;
                      infoMoves.textContent = `Coups: ${moves}`;
                      const [c1, c2] = opened;
                      if (c1.cardValue === c2.cardValue) {
                        matchSound.play();
                        c1.locked = true;
                        c2.locked = true;
                        matchedPairs++;

                        scene.tweens.add({
                          targets: [c1, c2],
                          scale: 1.12,
                          yoyo: true,
                          duration: 250
                        });

                        if(matchedPairs === PAIRS) {
                          clearInterval(timerEvent);
                          winSound.play();
                          overlay.setVisible(true);
                          victoryText.setText(`Bravo !\n${moves} coups\n${timer}s`);
                          victoryText.setVisible(true);

                          scene.tweens.add({
                            targets: victoryText,
                            scale: 1.2,
                            yoyo: true,
                            repeat: 4,
                            duration:300
                          });

                          canClick = false;
                        }

                        opened = [];
                        setTimeout(() => { canClick = true; }, 180);
                      }
                      else {
                        failSound.play();
                        setTimeout(() => {
                          scene.tweens.add({
                            targets: [c1, c2],
                            scaleX: 0,
                            duration: 120,
                            onComplete: () => {
                              [c1, c2].forEach(card => {
                                card.cardBack.setVisible(true);
                                card.cardFace.setVisible(false);
                                card.flipped = false;
                              });
                              scene.tweens.add({
                                targets: [c1, c2],
                                scaleX: 1,
                                duration: 100,
                                onComplete: () => {
                                  opened = [];
                                  canClick = true;
                                }
                              });
                            }
                          });
                        }, 500);
                      }
                    }
                    else {
                      canClick = true;
                    }
                  }
                });
              }
            });
          });
        }
      }

      document.getElementById('restartBtn').addEventListener('click', () => {
        clearInterval(timerEvent);
        game.destroy(true);
        document.getElementById('game-container').innerHTML = '';
        setTimeout(() => {
          game = new Phaser.Game(createConfig());
        }, 50);
      });
    }

    // Gestion du bouton plein écran - bascule et tooltip
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    fullscreenBtn.addEventListener('click', () => {
      if(!document.fullscreenElement) {
        const elem = document.documentElement;
        if(elem.requestFullscreen) elem.requestFullscreen();
        else if(elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if(elem.mozRequestFullScreen) elem.mozRequestFullScreen();
        else if(elem.msRequestFullscreen) elem.msRequestFullscreen();
      } else {
        if(document.exitFullscreen) document.exitFullscreen();
        else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if(document.mozCancelFullScreen) document.mozCancelFullScreen();
        else if(document.msExitFullscreen) document.msExitFullscreen();
      }
    });

    document.addEventListener('fullscreenchange', () => {
      if(document.fullscreenElement) {
        fullscreenBtn.title = 'Quitter le plein écran';
        fullscreenBtn.textContent = '❎';
      }
      else {
        fullscreenBtn.title = 'Plein écran';
        fullscreenBtn.textContent = '🔲';
      }
    });

    window.addEventListener('resize', () => {
      if(game) {
        game.destroy(true);
        document.getElementById('game-container').innerHTML = '';
        setTimeout(() => {
          game = new Phaser.Game(createConfig());
        }, 50);
      }
    });

    window.onload = () => {
      game = new Phaser.Game(createConfig());
    };
  </script>

</body>
</html>
