<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Memory F1 - 15 Paires - Plein écran toggle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      background: #243;
      color: #fff;
      font-family: sans-serif;
      user-select: none;
      overflow: hidden;
    }
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      background: #111c;
      color: #fff;
      font-size: 16px;
      height: 40px;
      max-width: 1100px;
      margin: 10px auto 0;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #header > div {
      min-width: 75px;
      text-align: center;
      flex-shrink: 0;
    }
    .header-center {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    #restartBtn, #fullscreenBtn {
      margin: 0;
      position: static;
      cursor: pointer;
      padding: 6px 14px;
      border-radius: 5px;
      border: none;
      background: #0a74da;
      color: white;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 6px #111a;
      user-select: none;
      transition: background 0.2s;
    }
    #fullscreenBtn {
      font-size: 20px;
      padding: 6px 10px 6px 10px;
      margin-left: 3px;
      background: #0a5ba8;
      min-width: 36px;
      width: 36px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #restartBtn:hover, #fullscreenBtn:hover {
      background: #09508c;
    }
    #game-container {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      top: 60px; /* sous le header */
      width: 100vw;
      height: calc(100vh - 60px);
      max-width: 1100px;
      margin: 0 auto;
      background: #222;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      image-rendering: crisp-edges;
      user-select: none;
    }
    @media (max-width: 700px) {
      #header { font-size: 13px; height: 36px; padding: 3px 5px; }
      #restartBtn, #fullscreenBtn { font-size: 15px; padding: 4px 7px; height: 32px; }
      .header-center { gap: 4px; }
    }
  </style>
</head>
<body>
  <div id="header">
    <div id="infoMoves">Coups: 0</div>
    <div class="header-center">
      <button id="restartBtn">Rejouer</button>
      <button id="fullscreenBtn" title="Plein écran">🔲</button>
    </div>
    <div id="infoTimer">Temps: 0s</div>
  </div>

  <div id="game-container"></div>

  <script>
    const PAIRS = 15;
    const COLS = 6;
    const ROWS = 5;
    const CARD_RATIO = 3 / 2;
    const CARD_GAP_RATIO = 0.03;

    let game, matchSound, failSound, winSound;

    function getSizes() {
      const container = document.getElementById('game-container');
      const w = container.clientWidth;
      const h = container.clientHeight;
      const totalGapWidth = (COLS - 1) * CARD_GAP_RATIO * w;
      const totalGapHeight = (ROWS - 1) * CARD_GAP_RATIO * h;
      let cardWidth = (w - totalGapWidth) / COLS;
      let cardHeight = cardWidth / CARD_RATIO;
      if (ROWS * cardHeight + totalGapHeight > h) {
        cardHeight = (h - totalGapHeight) / ROWS;
        cardWidth = cardHeight * CARD_RATIO;
      }
      const gapWidth = CARD_GAP_RATIO * cardWidth;
      const gapHeight = CARD_GAP_RATIO * cardHeight;
      const boardWidth = COLS * cardWidth + (COLS - 1) * gapWidth;
      const boardHeight = ROWS * cardHeight + (ROWS - 1) * gapHeight;
      const startX = (w - boardWidth) / 2 + cardWidth / 2;
      const startY = (h - boardHeight) / 2 + cardHeight / 2;
      return { w, h, cardWidth, cardHeight, gapWidth, gapHeight, startX, startY };
    }

    function createConfig() {
      return {
        type: Phaser.AUTO,
        parent: 'game-container',
        width: document.getElementById('game-container').clientWidth,
        height: document.getElementById('game-container').clientHeight,
        backgroundColor: '#243',
        scene: { preload, create },
        scale: { mode: Phaser.Scale.NONE, autoCenter: Phaser.Scale.CENTER_BOTH }
      };
    }

    function preload() {
      this.load.image('back', 'assets/carte-dos.jpg');
      for (let i = 1; i <= PAIRS; i++) {
        this.load.image('face' + i, `assets/${i}.jpg`);
      }
      this.load.audio('matchSound', 'sounds/match.mp3');
      this.load.audio('failSound', 'sounds/fail.mp3');
      this.load.audio('winSound', 'sounds/win.mp3');
    }

    function create() {
      const scene = this;
      const { cardWidth, cardHeight, gapWidth, gapHeight, startX, startY, w, h } = getSizes();

      let moves = 0;
      let matchedPairs = 0;
      let timer = 0;
      let opened = [];
      let canClick = true;

      const infoMoves = document.getElementById('infoMoves');
      const infoTimer = document.getElementById('infoTimer');
      infoMoves.textContent = 'Coups: 0';
      infoTimer.textContent = 'Temps: 0s';

      matchSound = this.sound.add('matchSound');
      failSound = this.sound.add('failSound');
      winSound = this.sound.add('winSound');

      const overlay = this.add.rectangle(w / 2, h / 2, w, h, 0x000000, 0.5).setDepth(20).setVisible(false);
      const victoryText = this.add.text(w / 2, h / 2, '', {
        font: '40px Arial',
        fill: '#0f0',
        backgroundColor: '#222d',
        padding: { left: 24, right: 24, top: 16, bottom: 16 },
        align: 'center',
        wordWrap: { width: w * 0.8 }
      }).setOrigin(0.5).setDepth(21).setVisible(false);

      this.input.once('pointerdown', () => {
        if (this.sound.context.state === 'suspended') this.sound.context.resume();
      });

      const timerEvent = setInterval(() => {
        timer++;
        infoTimer.textContent = `Temps: ${timer}s`;
      }, 1000);

      let values = [];
      for (let i = 1; i <= PAIRS; i++) values.push(i, i);
      Phaser.Utils.Array.Shuffle(values);

      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          let idx = y * COLS + x;
          if (idx >= values.length) break;
          let value = values[idx];
          let posX = startX + x * (cardWidth + gapWidth);
          let posY = startY + y * (cardHeight + gapHeight);

          let card = scene.add.container(posX, posY);
          let cardBack = scene.add.image(0, 0, 'back').setDisplaySize(cardWidth, cardHeight);
          let cardFace = scene.add.image(0, 0, `face${value}`).setDisplaySize(cardWidth, cardHeight).setVisible(false);

          card.add([cardBack, cardFace]);

          card.setSize(cardWidth, cardHeight);
          card.setInteractive();

          card.cardValue = value;
          card.flipped = false;
          card.locked = false;
          card.cardBack = cardBack;
          card.cardFace = cardFace;

          card.on('pointerdown', () => {
            if (!canClick || card.flipped || card.locked) return;
            canClick = false;
            scene.tweens.add({
              targets: card,
              scaleX: 0,
              duration: 120,
              onComplete: () => {
                card.cardBack.setVisible(false);
                card.cardFace.setVisible(true);
                scene.tweens.add({
                  targets: card,
                  scaleX: 1,
                  duration: 110,
                  onComplete: () => {
                    card.flipped = true;
                    opened.push(card);
                    if (opened.length === 2) {
                      moves++;
                      infoMoves.textContent = `Coups: ${moves}`;
                      let [first, second] = opened;
                      if (first.cardValue === second.cardValue) {
                        matchSound.play();
                        first.locked = second.locked = true;
                        matchedPairs++;
                        scene.tweens.add({ targets: [first, second], scale: 1.12, yoyo: true, duration: 250 });

                        if (matchedPairs === PAIRS) {
                          clearInterval(timerEvent);
                          winSound.play();
                          overlay.setVisible(true);
                          victoryText.setText(`Félicitations !\n${moves} coups\n${timer}s`);
                          victoryText.setVisible(true);
                          scene.tweens.add({ targets: victoryText, scale: 1.2, yoyo: true, repeat: 4, duration: 300 });
                          canClick = false;
                        }
                        opened = [];
                        setTimeout(() => { canClick = true; }, 200);
                      } else {
                        failSound.play();
                        setTimeout(() => {
                          scene.tweens.add({
                            targets: [first, second],
                            scaleX: 0,
                            duration: 150,
                            onComplete: () => {
                              [first, second].forEach(c => {
                                c.cardBack.setVisible(true);
                                c.cardFace.setVisible(false);
                                c.flipped = false;
                              });
                              scene.tweens.add({
                                targets: [first, second],
                                scaleX: 1,
                                duration: 150,
                                onComplete: () => {
                                  opened = [];
                                  canClick = true;
                                }
                              });
                            }
                          });
                        }, 700);
                      }
                    } else {
                      canClick = true;
                    }
                  }
                });
              }
            });
          });
        }
      }

      document.getElementById('restartBtn').onclick = () => {
        clearInterval(timerEvent);
        game.destroy(true);
        document.getElementById('game-container').innerHTML = '';
        setTimeout(() => {
          game = new Phaser.Game(createConfig());
        }, 20);
      };
    }

    // Gestion du bouton plein écran : toggle complet + modif icône et tooltip
    document.getElementById('fullscreenBtn').onclick = () => {
      if (!document.fullscreenElement &&
          !document.webkitFullscreenElement &&
          !document.mozFullScreenElement &&
          !document.msFullscreenElement) {
        const elem = document.documentElement;
        if (elem.requestFullscreen) elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
        else if (document.msExitFullscreen) document.msExitFullscreen();
      }
    };

    // Mise à jour icône + tooltip au changement d'état fullscreen
    document.addEventListener('fullscreenchange', () => {
      const btn = document.getElementById('fullscreenBtn');
      if (document.fullscreenElement) {
        btn.title = 'Quitter le plein écran';
        btn.textContent = '❎';
      } else {
        btn.title = 'Plein écran';
        btn.textContent = '🔲';
      }
    });

    window.addEventListener('resize', () => {
      if (game) {
        game.destroy(true);
        document.getElementById('game-container').innerHTML = '';
        setTimeout(() => {
          game = new Phaser.Game(createConfig());
        }, 20);
      }
    });

    window.onload = () => {
      game = new Phaser.Game(createConfig());
    };
  </script>

</body>
</html>
